<!DOCTYPE html><html lang="id" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-terraform-aws-load-balancer-auto-scaling"><head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform | How to</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:image" content="https://howto.novalagung.com/img/cover_media_share.png?v=1"><meta data-rh="true" property="og:url" content="https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling"><meta data-rh="true" name="docusaurus_locale" content="id"><meta data-rh="true" name="docsearch:language" content="id"><meta data-rh="true" name="author" content="Noval Agung Prayogo"><meta data-rh="true" property="og:image" content="https://howto.novalagung.com/img/cover_media_share.png?v=1"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform | How to"><meta data-rh="true" name="description" content="How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform"><meta data-rh="true" property="og:description" content="How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform"><meta data-rh="true" name="keywords" content="aws,ec2,alb,terraform,serverless,automation"><link data-rh="true" rel="icon" href="/img/favicon.png?v=1"><link data-rh="true" rel="canonical" href="https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling"><link data-rh="true" rel="alternate" href="https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling" hreflang="id"><link data-rh="true" rel="alternate" href="https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-69CJWBHP10"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-69CJWBHP10",{})</script><link rel="stylesheet" href="/assets/css/styles.fa041089.css">
<link rel="preload" href="/assets/js/runtime~main.9e262ab2.js" as="script">
<link rel="preload" href="/assets/js/main.af3309d8.js" as="script">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#article","isPartOf":{"@type":"WebPage","@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#webpage"},"author":{"name":"Noval Agung Prayogo","@id":"https://howto.novalagung.com/#/schema/person/1"},"headline":"How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform","mainEntityOfPage":{"@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#webpage"},"wordCount":1019,"publisher":{"@id":"https://howto.novalagung.com/#organization"},"image":{"@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#primaryimage"},"thumbnailUrl":"https://howto.novalagung.com/img/cover_media_share.png?v=1","keywords":["aws","ec2","alb","terraform","serverless","automation"],"articleSection":["Blog"],"inLanguage":"id"},{"@type":"WebPage","isPartOf":{"@id":"https://howto.novalagung.com/#website"},"inLanguage":"id","@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#webpage","url":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling","name":"How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform","description":"How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform","datePublished":"2023-10-03T08:34:35.836Z","dateModified":"2023-10-03T08:34:35.836Z","breadcrumb":{"@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#breadcrumb"},"potentialAction":[{"@type":"ReadAction","target":["https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling"]}]},{"@type":"ImageObject","inLanguage":"id","@id":"https://howto.novalagung.com/terraform-aws-load-balancer-auto-scaling/#primaryimage","url":"https://howto.novalagung.com/img/cover_media_share.png?v=1","contentUrl":"https://howto.novalagung.com/img/cover_media_share.png?v=1","caption":"How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform","width":600,"height":320},{"@type":"WebSite","@id":"https://howto.novalagung.com/#website","name":"How to","url":"https://howto.novalagung.com","description":"A bunch of tech tutorials","publisher":{"@id":"https://howto.novalagung.com/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://howto.novalagung.com/search?q={searchTerms}"},"query-input":"required name=searchTerms"}],"inLanguage":"id"},{"@type":"Organization","@id":"https://howto.novalagung.com/#organization","name":"How to","url":"https://howto.novalagung.com","sameAs":["https://web.facebook.com/adamstudio.page","https://www.instagram.com/adamstudio.ig","https://github.com/adamstudiogh"],"contactPoint":{"@type":"ContactPoint","email":"hello@novalagung.com"},"logo":{"@type":"ImageObject","inLanguage":"id","@id":"adamstudio","url":"https://avatars.githubusercontent.com/u/65223287","contentUrl":"https://avatars.githubusercontent.com/u/65223287","width":1440,"height":900,"caption":"Adam Studio"}},{"@type":"Person","@id":"https://howto.novalagung.com/#/schema/person/1","name":"Noval Agung Prayogo","image":{"@type":"ImageObject","inLanguage":"id","@id":"https://howto.novalagung.com/#/schema/person/image/1","url":"https://i.stack.imgur.com/99yxf.jpg","contentUrl":"https://i.stack.imgur.com/99yxf.jpg","caption":"Noval Agung Prayogo"},"sameAs":["https://stackoverflow.com/users/1467988/novalagung","https://www.udemy.com/user/noval-agung-prayogo","https://apps.apple.com/id/developer/noval-agung-prayogo/id1163677873?l=id","https://novalagung.medium.com","https://adplist.org/mentors/noval-agung-prayogo","https://novalagung.com","https://linktr.ee/novalagung","https://www.instagram.com/novalagung","https://www.facebook.com/novalagungprayogo","https://www.codementor.io/@novalagung"],"url":"https://www.linkedin.com/in/novalagung"}]}</script></head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://howto.novalagung.com/img/logo_small_dark.png" alt="How To - A bunch of tech tutorials" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://howto.novalagung.com/img/logo_small_light.png" alt="How To - A bunch of tech tutorials" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">How To</b></a></div><div class="navbar__items navbar__items--right"><div style="margin-top:8px;margin-right:15px"><a class="github-button" href="https://github.com/novalagung/howto" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star novalagung/howto on GitHub">Star</a>&nbsp;<a class="github-button" href="https://github.com/novalagung" data-size="large" aria-label="Follow @novalagung on GitHub">Follow @novalagung</a></div><div class="toggle_vylO colorModeToggle_x44X"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">🏠 Homepage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aws-create-iam-user-access-credentials">Create IAM User Access Credentials in AWS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cicd-serverless-ebook-gitbook-github-pages-actions-calibre">Setup Serverless Ebook using Gitbook CLI, Github Pages, Github Actions CI/CD, and Calibre</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docker-push-image-to-hub">Push Docker Image to Docker Hub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/kubernetes-minikube-deployment-service-horizontal-autoscale">Deploy App to Minikube Cluster using Deployment controller, Service, and HPA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-oracle-instantclient">Setup Oracle Instant Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-oracle-xe-database-server">Setup Oracle XE Database Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-wireguard-vpn-server">Setup WireGuard VPN Server + UI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/terraform-aws-ec2-internet-gateway-ssh">Automate Setup of AWS EC2 with IGW and SSH Access enabled using Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/terraform-aws-load-balancer-auto-scaling">Automate Setup of AWS EC2 with ALB and Auto Scaling enabled using Terraform</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Automate Setup of AWS EC2 with ALB and Auto Scaling enabled using Terraform</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How to Automate Setup of AWS EC2 with Application Load Balancer and Auto Scaling enabled using Terraform</h1></header><p>In this post, we are going to learn about the usage of Terraform to automate the setup of AWS EC2 instance in an auto-scaling environment with an Application Load Balancer applied.</p><p>Since we will be using the auto-scaling feature, then the app within the instance needs to be deployed in an automated manner.</p><p>The application is a simple go app, currently hosted on Github in a private repo. We will clone the app using Github token, we will talk about it in details in some part of this tutorial.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-prerequisites">1. Prerequisites<a class="hash-link" href="#1-prerequisites" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-terraform-cli">1.1. Terraform CLI<a class="hash-link" href="#11-terraform-cli" title="Direct link to heading">​</a></h3><p>Ensure terraform CLI is available. If not, then do install it first.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-individual-aws-iam-user">1.2. Individual AWS IAM user<a class="hash-link" href="#12-individual-aws-iam-user" title="Direct link to heading">​</a></h3><p>Prepare a new individual IAM user with programmatic access key enabled and have access to EC2 management. We will use the <code>access_key</code> and <code>secret_key</code> on this tutorial. If you haven't created the IAM user, then follow a guide on <a href="/aws-create-iam-user-access-credentials">How to Create IAM User Access Credentials in AWS</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-ssh-keygen-and-ssh-commands">1.3. <code>ssh-keygen</code> and <code>ssh</code> commands<a class="hash-link" href="#13-ssh-keygen-and-ssh-commands" title="Direct link to heading">​</a></h3><p>Ensure both <code>ssh-keygen</code> and <code>ssh</code> command are available.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-preparation">2. Preparation<a class="hash-link" href="#2-preparation" title="Direct link to heading">​</a></h2><p>Create a new folder contains a file named <code>infrastructure.tf</code>. We will use the file as the infrastructure code. Every resource setup will be written in HCL language inside the file, including: </p><ul><li>Uploading key pair (for ssh access to the instance).</li><li>Subnetting on two different availability zones (within the same region).</li><li>Defining Application Load Balancer, it's listener, security group, and target group.</li><li>Defining Auto-scaling and it's launch config.</li></ul><p>Ok, let's back to the tutorial. Now create the infrastructure file.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> terraform-automate-aws-ec2-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> terraform-automate-aws-ec2-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">touch</span><span class="token plain"> infrastructure.tf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, create a public-key cryptography using <code>ssh-keygen</code> command below. This will generate the <code>id_rsa.pub</code> public key and <code>id_rsa</code> private key. Later we will upload the public key into AWS and use the private key to perform <code>ssh</code> access into the newly created EC2 instance.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> terraform-automate-aws-ec2-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keygen </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> rsa </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> ./id_rsa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Terraform - Automate setup of AWS EC2 with Load Balancer and Auto Scaling enabled - generate key pair" src="/assets/images/terraform-aws-load-balancer-auto-scaling-1-ba5e025e427d681d2c7f18acf09d0573.png" width="993" height="365" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-infrastructure-code">3. Infrastructure Code<a class="hash-link" href="#3-infrastructure-code" title="Direct link to heading">​</a></h2><p>Now we shall start writing the infrastructure config. Open <code>infrastructure.tf</code> in any editor.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-define-aws-provider">3.1. Define AWS provider<a class="hash-link" href="#31-define-aws-provider" title="Direct link to heading">​</a></h3><p>Define the provider block with <a href="https://www.terraform.io/docs/providers/aws/index.html" target="_blank" rel="noopener noreferrer">AWS as chosen cloud provider</a>. Also define these properties: <code>region</code>, <code>access_key</code>, and <code>secret_key</code>; with values derived from the created IAM user.</p><p>Write a block of code below into <code>infrastructure.tf</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider </span><span class="token string" style="color:#e3116c">"aws"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ap-southeast-1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AKIAWLTS5CSXP7E3YLWG"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secret_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"+IiZmuocoN7ypY8emE79awHzjAjG8wC2Mc/ZAHK6"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-generate-new-key-pair-then-upload-to-aws">3.2. Generate new key pair then upload to AWS<a class="hash-link" href="#32-generate-new-key-pair-then-upload-to-aws" title="Direct link to heading">​</a></h3><p>Define new <a href="https://www.terraform.io/docs/providers/aws/r/key_pair.html" target="_blank" rel="noopener noreferrer"><code>aws_key_pair</code> resource</a> block with local name: <code>my_instance_key_pair</code>. Put the previously generated <code>id_rsa.pub</code> public key inside the block to upload it to AWS.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_key_pair"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_instance_key_pair"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"terraform_learning_key_1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"id_rsa.pub"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-book-a-vpc-and-enable-internet-gateway-on-it">3.3. Book a VPC, and enable internet gateway on it<a class="hash-link" href="#33-book-a-vpc-and-enable-internet-gateway-on-it" title="Direct link to heading">​</a></h3><p>Book a VPC, name it <code>my_vpc</code>. Then enable internet gateway on it. Each part of the code below is self-explanatory.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># allocate a vpc named my_vpc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_vpc"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_vpc"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.0.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_dns_hostnames </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setup internet gateway for my_vpc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_internet_gateway"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_vpc_igw"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># attach the internet gateway my_vpc_igw into my_vpc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_route_table"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_public_route_table"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gateway_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_internet_gateway.my_vpc_igw.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-allocate-two-different-subnets-on-two-different-availability-zones-within-the-same-region">3.4. Allocate two different subnets on two different availability zones (within the same region)<a class="hash-link" href="#34-allocate-two-different-subnets-on-two-different-availability-zones-within-the-same-region" title="Direct link to heading">​</a></h3><p>Application Load Balancer or ALB requires two subnets setup on two availability zones (within the same region).</p><p>In this example, the region we used is <code>ap-southeast-1</code>, as defined in the provider block above (see 3.1). There are two zones available within this region, <code>ap-southeast-1a</code> and <code>ap-southeast-1b</code>. The ALB (not classic network load balancer) requires at least to be enabled on two different zones, so we will use those two.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># prepare a subnet for availability zone ap-southeast-1a.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_subnet"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_subnet_public_southeast_1a"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.0.0.0/24"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    availability_zone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ap-southeast-1a"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># associate the internet gateway into newly created subnet for ap-southeast-1a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_route_table_association"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_public_route_association_for_southeast_1a"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnet_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_subnet.my_subnet_public_southeast_1a.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route_table_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_route_table.my_public_route_table.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># prepare a subnet for availability zone ap-southeast-1b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_subnet"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_subnet_public_southeast_1b"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_block </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.0.1.0/24"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    availability_zone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ap-southeast-1b"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># associate the internet gateway into newly created subnet for ap-southeast-1b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_route_table_association"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_public_route_association_for_southeast_1b"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnet_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_subnet.my_subnet_public_southeast_1b.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route_table_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_route_table.my_public_route_table.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The internet gateway associated with two zones that we just created. In this example, it is required for the application hosted within instances on these zones to be able to connect to the internet.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="35-define-alb-resource-block-listener-security-group-and-target-group">3.5. Define ALB resource block, listener, security group, and target group<a class="hash-link" href="#35-define-alb-resource-block-listener-security-group-and-target-group" title="Direct link to heading">​</a></h3><p>The ALB will be created with two subnets attached (subnets from <code>ap-southeast-1a</code> and <code>ap-southeast-1b</code>).</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create an Application Load Balancer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># attach the previous availability zones' subnets into this load balancer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_lb"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_alb"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my-alb"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># set lb for public access</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_balancer_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"application"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># use Application Load Balancer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">aws_security_group.my_alb_security_group.id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># attach the availability zones' subnets.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aws_subnet.my_subnet_public_southeast_1a.id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aws_subnet.my_subnet_public_southeast_1b.id </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The security group for our load balancer has only two rules.</p><ul><li>Allow only incoming TCP/HTTP request on port <code>80</code>.</li><li>Allow every kind of outgoing request.</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># prepare a security group for our load balancer my_alb.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_security_group"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_alb_security_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tcp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_blocks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    egress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_blocks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we shall prepare the ALB listener. The load balancer will listen for every incoming request to port <code>80</code>, and then the particular request will be directed towards port <code>8080</code> on the instance.</p><p>Port <code>8080</code> is chosen here because the application (that will be deployed later) will listen to this port.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create an alb listener for my_alb.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># forward rule: only accept incoming HTTP request on port 80,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># then it'll be forwarded to port target:8080.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_lb_listener"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_alb_listener"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_balancer_arn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_lb.my_alb.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HTTP"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_action </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target_group_arn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_lb_target_group.my_alb_target_group.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"forward"</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># my_alb will forward the request to a particular app,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># that listen on 8080 within instances on my_vpc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_lb_target_group"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_alb_target_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HTTP"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="36-define-launch-config-and-its-required-dependencies-for-auto-scaling">3.6. Define launch config (and it's required dependencies) for auto-scaling<a class="hash-link" href="#36-define-launch-config-and-its-required-dependencies-for-auto-scaling" title="Direct link to heading">​</a></h3><p>We are not going to simply create an instance then deploy the application into it. Instead, the instance creation and app deployment will be automated using AWS auto-scaling feature.</p><p>In the resource block below, we will set up the launch configuration for the auto-scaling. This launch config is the one that decides how the instance will be created.</p><ul><li>The <em>Amazon Linux 2 AMI t2.micro</em> is used here.</li><li>The launched instance will have a public IP attached, this is better to be set to <code>false</code>, but in here we might need it for testing purposes.</li><li>The previously allocated key pair will also be used on the instance, to make it accessible through SSH access. This part is also for testing purposes.</li></ul><p>Other than that, there is one point left that is very important, the <code>user_data</code>. The user data is a block of bash script that will be executed during instance bootstrap. We will use this to automate the deployment of our application. The whole script is stored in a file named <code>deployment.sh</code>, we will prepare it later.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># setup launch configuration for the auto-scaling.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_launch_configuration"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_launch_configuration"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Amazon Linux 2 AMI (HVM), SSD Volume Type (ami-0f02b24005e4aec36).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ami-0f02b24005e4aec36"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t2.micro"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_key_pair.my_instance_key_pair.key_name </span><span class="token comment" style="color:#999988;font-style:italic"># terraform_learning_key_2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_groups </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">aws_security_group.my_launch_config_security_group.id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># set to false on prod stage.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># otherwise true, because ssh access might be needed to the instance.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    associate_public_ip_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lifecycle </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ensure the new instance is only created before the other one is destroyed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_before_destroy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># execute bash scripts inside deployment.sh on instance's bootstrap.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># what the bash scripts going to do in summary:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fetch a hello world app from Github repo, then deploy it in the instance.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"deployment.sh"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Below is the launch config security group. In this block, we define the security group specifically for the instances that will be created by the auto scale launch config. Three rules defined here:</p><ul><li>Allow incoming <code>TCP/SSH</code> access on port <code>22</code>.</li><li>Allow <code>TCP/HTTP</code> access on port <code>8080</code>.</li><li>Allow every kind of outgoing requests.</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># security group for launch config my_launch_configuration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_security_group"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_launch_config_security_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_vpc.my_vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tcp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_blocks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tcp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_blocks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    egress </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cidr_blocks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"0.0.0.0/0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ok, the autoscale launch config is ready, now we shall attach it into our ALB.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create an autoscaling then attach it into my_alb_target_group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_autoscaling_attachment"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_aws_autoscaling_attachment"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alb_target_group_arn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_lb_target_group.my_alb_target_group.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autoscaling_group_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_autoscaling_group.my_autoscaling_group.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we shall prepare the auto-scaling group config. This resource is used to determine when or on what condition the scaling process run.</p><ul><li>As per the below config, the auto-scaling will have a minimum of 2 instances alive, and 5 max.</li><li>The <code>ELB</code> health check is enabled.</li><li>The previous two subnets on <code>ap-southeast-1a</code> and <code>ap-southeast-1b</code> are applied.</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># define the autoscaling group.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># attach my_launch_configuration into this newly created autoscaling group below.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">"aws_autoscaling_group"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my_autoscaling_group"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my-autoscaling-group"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desired_capacity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ideal number of instance alive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># min number of instance alive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># max number of instance alive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    health_check_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ELB"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># allows deleting the autoscaling group without waiting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># for all instances in the pool to terminate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    force_delete </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    launch_configuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_launch_configuration.my_launch_configuration.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vpc_zone_identifier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aws_subnet.my_subnet_public_southeast_1a.id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aws_subnet.my_subnet_public_southeast_1b.id </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeouts </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"15m"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># timeout duration for instances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lifecycle </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ensure the new instance is only created before the other one is destroyed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_before_destroy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="37-print-the-alb-public-dns">3.7. Print the ALB public DNS<a class="hash-link" href="#37-print-the-alb-public-dns" title="Direct link to heading">​</a></h3><p>Everything is pretty much done, except we need to print the ALB public DNS, so then we can do the testing.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># print load balancer's DNS, test it using curl.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># curl my-alb-625362998.ap-southeast-1.elb.amazonaws.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"alb-url"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_lb.my_alb.dns_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-app-deployment-script">4. App Deployment Script<a class="hash-link" href="#4-app-deployment-script" title="Direct link to heading">​</a></h2><p>We have done with the infrastructure code, next prepare the deployment script.</p><p>Create a file named <code>deployment.sh</code> in the same directory where the infra code is placed. It will contain bash scripts for automating app deployment. This file will be used by auto-scaling launcher to automate app setup during instance bootstrap.</p><p>The application is written in Go, and the AMI <em>Amazon Linux 2 AMI t2.micro</em> that used here does not have any Go tools ready, that's why we need to set it up.</p><blockquote><p><strong>Deploying app</strong> means that the app is ready (has been built into binary), so what we need is simply just run the binary.</p></blockquote><blockquote><p>However to make our learning process better, in this example, we are going to fetch the app source code and perform the build and deploy processes within the instance.</p></blockquote><p>Ok, here we go, the bash script.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># install git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> yum </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># download go, then install it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dl.google.com/go/go1.14.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /usr/local </span><span class="token parameter variable" style="color:#36acaa">-xzf</span><span class="token plain"> go1.14.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># clone the hello world app.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The app is hosted on private repo,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># that's why the github token is used on cloning the repo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">github_token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">30542dd8874ba3745c55203a091c345340c18b7a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://</span><span class="token variable" style="color:#36acaa">$github_token</span><span class="token plain">:x-oauth-basic@github.com/novalagung/hello-world.git </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cloned"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"clone failed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># export certain variables required by go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GO111MODULE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOROOT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/local/go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOCACHE</span><span class="token operator" style="color:#393A34">=~</span><span class="token plain">/gocache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$GOCACHE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOPATH</span><span class="token operator" style="color:#393A34">=~</span><span class="token plain">/goapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$GOPATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># create local vars specifically for the app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">INSTANCE_ID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">curl</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable parameter variable" style="color:#36acaa">-s</span><span class="token variable" style="color:#36acaa"> http://169.254.169.254/latest/meta-data/instance-id</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># build the app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> hello-world</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/go/bin/go </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/go/bin/go mod tidy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/go/bin/go build </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> binary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># run the app with nohup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nohup</span><span class="token plain"> ./binary </span><span class="token operator" style="color:#393A34">&amp;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-run-terraform">5. Run Terraform<a class="hash-link" href="#5-run-terraform" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-terraform-initialization">5.1. Terraform initialization<a class="hash-link" href="#51-terraform-initialization" title="Direct link to heading">​</a></h3><p>First, run the <code>terraform init</code> command. This command will do some setup/initialization, certain dependencies (like AWS provider that we used) will be downloaded.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> terraform-automate-aws-ec2-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-terraform-plan">5.2. Terraform plan<a class="hash-link" href="#52-terraform-plan" title="Direct link to heading">​</a></h3><p>Next, run <code>terraform plan</code>, to see the plan of our infrastructure. This step is optional, however, might be useful for us to see the outcome from the infra file.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-terraform-apply">5.3. Terraform apply<a class="hash-link" href="#53-terraform-apply" title="Direct link to heading">​</a></h3><p>Last, run the <code>terraform apply</code> command to execute the infrastructure plan.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> terraform-automate-aws-ec2-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>-auto-approve</code> flag is optional, it will skip the confirmation prompt during execution.</p><p>After the process is done, public DNS shall appear. Next, we shall test the instance. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-test-instance">6. Test Instance<a class="hash-link" href="#6-test-instance" title="Direct link to heading">​</a></h2><p>Use the <code>curl</code> command to make an HTTP request to the ALB public DNS instance.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-X</span><span class="token plain"> GET my-alb-613171058.ap-southeast-1.elb.amazonaws.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Terraform - Automate setup of AWS EC2 with Load Balancer and Auto Scaling enabled - curl to load balancer" src="/assets/images/terraform-aws-load-balancer-auto-scaling-2-f63deaa8977d1d53ea32e0ad7efb8f11.png" width="1236" height="603" class="img_ev3q"></p><p>We can see from the image above, the HTTP response is different from one another across those multiple <code>curl</code> commands. The load balancer manages the traffic, sometimes we will get the instance A, B, etc.</p><p>In the AWS console, the instances that up and running are visible.</p><p><img loading="lazy" alt="Terraform - Automate setup of AWS EC2 with Load Balancer and Auto Scaling enabled - aws console" src="/assets/images/terraform-aws-load-balancer-auto-scaling-3-1faa9fdb7d85034776ed019fa19665e9.png" width="1635" height="332" class="img_ev3q"></p></div><hr></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/terraform-aws-ec2-internet-gateway-ssh"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Automate Setup of AWS EC2 with IGW and SSH Access enabled using Terraform</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-prerequisites" class="table-of-contents__link toc-highlight">1. Prerequisites</a><ul><li><a href="#11-terraform-cli" class="table-of-contents__link toc-highlight">1.1. Terraform CLI</a></li><li><a href="#12-individual-aws-iam-user" class="table-of-contents__link toc-highlight">1.2. Individual AWS IAM user</a></li><li><a href="#13-ssh-keygen-and-ssh-commands" class="table-of-contents__link toc-highlight">1.3. <code>ssh-keygen</code> and <code>ssh</code> commands</a></li></ul></li><li><a href="#2-preparation" class="table-of-contents__link toc-highlight">2. Preparation</a></li><li><a href="#3-infrastructure-code" class="table-of-contents__link toc-highlight">3. Infrastructure Code</a><ul><li><a href="#31-define-aws-provider" class="table-of-contents__link toc-highlight">3.1. Define AWS provider</a></li><li><a href="#32-generate-new-key-pair-then-upload-to-aws" class="table-of-contents__link toc-highlight">3.2. Generate new key pair then upload to AWS</a></li><li><a href="#33-book-a-vpc-and-enable-internet-gateway-on-it" class="table-of-contents__link toc-highlight">3.3. Book a VPC, and enable internet gateway on it</a></li><li><a href="#34-allocate-two-different-subnets-on-two-different-availability-zones-within-the-same-region" class="table-of-contents__link toc-highlight">3.4. Allocate two different subnets on two different availability zones (within the same region)</a></li><li><a href="#35-define-alb-resource-block-listener-security-group-and-target-group" class="table-of-contents__link toc-highlight">3.5. Define ALB resource block, listener, security group, and target group</a></li><li><a href="#36-define-launch-config-and-its-required-dependencies-for-auto-scaling" class="table-of-contents__link toc-highlight">3.6. Define launch config (and it's required dependencies) for auto-scaling</a></li><li><a href="#37-print-the-alb-public-dns" class="table-of-contents__link toc-highlight">3.7. Print the ALB public DNS</a></li></ul></li><li><a href="#4-app-deployment-script" class="table-of-contents__link toc-highlight">4. App Deployment Script</a></li><li><a href="#5-run-terraform" class="table-of-contents__link toc-highlight">5. Run Terraform</a><ul><li><a href="#51-terraform-initialization" class="table-of-contents__link toc-highlight">5.1. Terraform initialization</a></li><li><a href="#52-terraform-plan" class="table-of-contents__link toc-highlight">5.2. Terraform plan</a></li><li><a href="#53-terraform-apply" class="table-of-contents__link toc-highlight">5.3. Terraform apply</a></li></ul></li><li><a href="#6-test-instance" class="table-of-contents__link toc-highlight">6. Test Instance</a></li></ul></div></div></div><div style="margin-top:30px"><div id="disqus_thread"></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">2023 | Maintained by Noval Agung Prayogo</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9e262ab2.js"></script>
<script src="/assets/js/main.af3309d8.js"></script>

</body></html>