<!DOCTYPE html><html lang="id" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-terraform-cloudflare-zero-trust"><head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">How to Restrict App Access using Cloudflare Zero Trust and Terraform | How to</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:image" content="https://howto.novalagung.com/img/cover_media_share.png"><meta data-rh="true" property="og:url" content="https://howto.novalagung.com/terraform-cloudflare-zero-trust"><meta data-rh="true" name="docusaurus_locale" content="id"><meta data-rh="true" name="docsearch:language" content="id"><meta data-rh="true" name="author" content="Noval Agung Prayogo"><meta data-rh="true" property="og:image" content="https://howto.novalagung.com/img/cover_media_share.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="fb:app_id" content="875100400724859"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="How to Restrict App Access using Cloudflare Zero Trust and Terraform | How to"><meta data-rh="true" name="description" content="How to restrict app access using Cloudflare Zero Trust and Terraform"><meta data-rh="true" property="og:description" content="How to restrict app access using Cloudflare Zero Trust and Terraform"><meta data-rh="true" name="keywords" content="terraform,cloudflare,zero trust,security,cyber security,2fa"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://howto.novalagung.com/terraform-cloudflare-zero-trust"><link data-rh="true" rel="alternate" href="https://howto.novalagung.com/terraform-cloudflare-zero-trust" hreflang="id"><link data-rh="true" rel="alternate" href="https://howto.novalagung.com/terraform-cloudflare-zero-trust" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-69CJWBHP10"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-69CJWBHP10",{})</script><link rel="stylesheet" href="/assets/css/styles.be671827.css">
<link rel="preload" href="/assets/js/runtime~main.b97f7968.js" as="script">
<link rel="preload" href="/assets/js/main.621dd5f0.js" as="script">
<script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#article","isPartOf":{"@type":"WebPage","@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#webpage"},"author":{"name":"Noval Agung Prayogo","@id":"https://howto.novalagung.com/#/schema/person/1"},"headline":"How to Restrict App Access using Cloudflare Zero Trust and Terraform","mainEntityOfPage":{"@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#webpage"},"wordCount":778,"publisher":{"@id":"https://howto.novalagung.com/#organization"},"image":{"@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#primaryimage"},"thumbnailUrl":"https://howto.novalagung.com/img/cover_media_share.png","keywords":["terraform","cloudflare","zero trust","security","cyber security","2fa"],"articleSection":["Blog"],"inLanguage":"id"},{"@type":"WebPage","isPartOf":{"@id":"https://howto.novalagung.com/#website"},"inLanguage":"id","@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#webpage","url":"https://howto.novalagung.com/terraform-cloudflare-zero-trust","name":"How to Restrict App Access using Cloudflare Zero Trust and Terraform","description":"How to restrict app access using Cloudflare Zero Trust and Terraform","datePublished":"2024-05-26T18:20:02.185Z","dateModified":"2024-05-26T18:20:02.185Z","breadcrumb":{"@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#breadcrumb"},"potentialAction":[{"@type":"ReadAction","target":["https://howto.novalagung.com/terraform-cloudflare-zero-trust"]}]},{"@type":"ImageObject","inLanguage":"id","@id":"https://howto.novalagung.com/terraform-cloudflare-zero-trust/#primaryimage","url":"https://howto.novalagung.com/img/cover_media_share.png","contentUrl":"https://howto.novalagung.com/img/cover_media_share.png","caption":"How to Restrict App Access using Cloudflare Zero Trust and Terraform","width":1200,"height":627},{"@type":"WebSite","@id":"https://howto.novalagung.com/#website","name":"How to","url":"https://howto.novalagung.com","description":"A bunch of tech tutorials","publisher":{"@id":"https://howto.novalagung.com/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://howto.novalagung.com/search?q={searchTerms}"},"query-input":"required name=searchTerms"}],"inLanguage":"id"},{"@type":"Organization","@id":"https://howto.novalagung.com/#organization","name":"How to","url":"https://howto.novalagung.com","sameAs":["https://web.facebook.com/adamstudio.page","https://www.instagram.com/adamstudio.ig","https://github.com/adamstudiogh","https://github.com/novalagung"],"contactPoint":{"@type":"ContactPoint","email":"hello@novalagung.com"},"logo":{"@type":"ImageObject","inLanguage":"id","@id":"adamstudio","url":"https://avatars.githubusercontent.com/u/65223287","contentUrl":"https://avatars.githubusercontent.com/u/65223287","width":1440,"height":900,"caption":"Adam Studio"}},{"@type":"Person","@id":"https://howto.novalagung.com/#/schema/person/1","name":"Noval Agung Prayogo","image":{"@type":"ImageObject","inLanguage":"id","@id":"https://howto.novalagung.com/#/schema/person/image/1","url":"https://i.stack.imgur.com/99yxf.jpg","contentUrl":"https://i.stack.imgur.com/99yxf.jpg","caption":"Noval Agung Prayogo"},"sameAs":["https://stackoverflow.com/users/1467988/novalagung","https://www.udemy.com/user/noval-agung-prayogo","https://apps.apple.com/id/developer/noval-agung-prayogo/id1163677873?l=id","https://novalagung.medium.com","https://adplist.org/mentors/noval-agung-prayogo","https://novalagung.com","https://linktr.ee/novalagung","https://www.instagram.com/novalagung","https://www.facebook.com/novalagungprayogo","https://www.codementor.io/@novalagung"],"url":"https://www.linkedin.com/in/novalagung"}]}</script></head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://howto.novalagung.com/img/logo_small_dark.png" alt="How to - A bunch of tech tutorials" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://howto.novalagung.com/img/logo_small_light.png" alt="How to - A bunch of tech tutorials" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">How to</b></a></div><div class="navbar__items navbar__items--right"><div style="margin-top:8px;margin-right:15px"><a class="github-button" href="https://github.com/sponsors/novalagung" data-color-scheme="no-preference: light; light: light; dark: dark;" data-icon="octicon-heart" data-size="large" aria-label="Sponsor @novalagung on GitHub">Sponsor</a>&nbsp;<a class="github-button" href="https://github.com/novalagung/howto" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star novalagung/howto on GitHub">Star</a>&nbsp;<a class="github-button" href="https://github.com/novalagung" data-size="large" aria-label="Follow @novalagung on GitHub">Follow @novalagung</a></div><div class="toggle_vylO colorModeToggle_x44X"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">üè† Homepage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/terraform-aws-load-balancer-auto-scaling">Automate Setup of AWS EC2 with ALB and Auto Scaling enabled using Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/terraform-aws-ec2-internet-gateway-ssh">Automate Setup of AWS EC2 with IGW and SSH Access enabled using Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/terraform-cloudflare-zero-trust">Restrict App Access using Cloudflare Zero Trust and Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/kubernetes-minikube-deployment-service-horizontal-autoscale">Deploy App to Minikube Cluster using Deployment controller, Service, and HPA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://novalagung.medium.com/gmail-account-with-custom-domain-using-cloudflare-and-mailgun-2fa51337911a" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Gmail Account with Custom Domain using Cloudflare and Mailgun<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://levelup.gitconnected.com/golang-dockerfile-for-project-with-private-dependencies-using-https-without-ssh-9a9f0bbeddd8" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Golang Dockerfile for Project with Private Dependencies using HTTPS (without SSH)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://javascript.plainenglish.io/react-native-bluetooth-low-energy-peripheral-communication-e7cb93abf69" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Peripheral Communication with React Native BLE (Bluetooth Low Energy)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-oracle-instantclient">Setup Oracle Instant Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-oracle-xe-database-server">Setup Oracle XE Database Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cicd-serverless-ebook-gitbook-github-pages-actions-calibre">Setup Serverless Ebook/Webbook using Gitbook CLI, Github Pages, Github Actions CI/CD, and Calibre</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://medium.com/geekculture/serverless-e-book-web-book-using-docusaurus-v2-github-pages-actions-and-pdf-tools-4fef54847b85" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Setup Serverless Ebook/Webbook using Docusaurus v2, GitHub Pages &amp; Actions, DocSearch, and PDF tools<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/setup-wireguard-vpn-server">Setup WireGuard VPN Server + UI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://novalagung.medium.com/soap-wsdl-request-in-go-language-3861cfb5949e" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">SOAP-WSDL request in Go Language<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Restrict App Access using Cloudflare Zero Trust and Terraform</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How to Restrict App Access using Cloudflare Zero Trust and Terraform</h1></header><p>This post is a straightforward hands-on tutorial about implementation of Cloudflare Zero Trust on website by using Terraform.</p><blockquote><p>This approach works only if your application DNS configured on Cloudflare DNS.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-terraform--opentofu-installation">1. Terraform / OpenTofu installation<a class="hash-link" href="#1-terraform--opentofu-installation" title="Direct link to heading">‚Äã</a></h2><p>Follow <a href="https://developer.hashicorp.com/terraform/install" target="_blank" rel="noopener noreferrer">Install Terraform</a> guide to get Terraform installed on your local machine. </p><blockquote><p>You folks can also use OpenTofu, either is fine.</p></blockquote><p>Once Terraform successfully installed, verify it using <code>terraform -version</code> command.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-1-fbd9e62a92fc511a62e6a3c85217d53f.png" width="609" height="119" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-cloudflare-api-token">2. Cloudflare API token<a class="hash-link" href="#2-cloudflare-api-token" title="Direct link to heading">‚Äã</a></h2><p>Login to Cloudflare, then navigate to the <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer">API Token page</a>, then click <code>Create Token</code> ‚Üí <code>Edit zone DNS</code> ‚Üí <code>Use Template</code>.</p><p>Ensure to have the following permission attached to your API Token:</p><ul><li>Access: Organizations, Identitiy Providers, and Groups</li><li>Access: Apps and Policies</li></ul><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-2-4bac1665478be602df661e73abd189a3.png" width="910" height="473" class="img_ev3q"></p><p>Then click <code>Continue Summary</code> ‚Üí <code>Create Token</code>. In the end, you will see the generated API token.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-3-27cfade0c96efd83bc1393a2aa30b9e4.png" width="725" height="210" class="img_ev3q"></p><p>The Cloudflare API token is going to be used on our Terraform (HCL) script for managing Cloudflare Zero Trust configuration programatically.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-project-setup">3. Project setup<a class="hash-link" href="#3-project-setup" title="Direct link to heading">‚Äã</a></h2><p>Let's create a new project for storing the <code>tf</code> files. Create a new folder with the following structure:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">project structure</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ‚Üí provider.cloudflare.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ‚Üí var.whitelist-access.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ‚Üí zero-trust.access-group.my-group.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ‚Üí zero-trust.application.wireguard.tf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, open <code>provider.cloudflare.tf</code> file, fill it with the script below:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/provider.cloudflare.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">required_providers</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">cloudflare</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">source</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cloudflare/cloudflare"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">version</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"~&gt; 4.33.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">provider</span><span class="token keyword type variable" style="color:#36acaa"> "cloudflare" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">api_token</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"206X7Ba7VwGeLAk93ffUtuMrI_v3vf4xr"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">variable</span><span class="token keyword type variable" style="color:#36acaa"> "account-id" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"5824f4cbcdf214e05000e217f686bba4"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Explanation:</p><ul><li><p>The <code>terraform</code> block and everything within is necessary for enabling Cloudflare resource management via Terraform. In the example, Terraform Cloudflare provider <code>v4.33.0</code> is being used.</p></li><li><p>The <code>provider "cloudflare"</code> block must contains the Cloudflare API Token information. Put the API token from <a href="/terraform-cloudflare-zero-trust#2-cloudflare-api-token">Step 3. Cloudflare API token</a> to the <code>api_token</code> variable within that block.</p></li><li><p>Put the Cloudflare account ID under <code>variable "account-id"</code> block. The account ID information is available on Cloudflare domain summary page, see on the bottom right section.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-4-3af6c44d0506035632542d902bf5169b.png" width="1148" height="737" class="img_ev3q"></p></li></ul><p>Now, run the following command to initialize the terraform project and to download the Cloudflare provider dependencies:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> my-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you see output similar to image below, then all good.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-5-03cbd7cab6c492a682fc915be5e79149.png" width="580" height="475" class="img_ev3q"></p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>If you are using Terraform Cloud, ensure to add the <code>cloud</code> block under <code>terraform</code> block, e.g:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/provider.cloudflare.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">terraform</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">cloud</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">organization</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"novalagung-org"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">workspaces</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my-workspace-name"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">required_providers</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">cloudflare</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">source</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cloudflare/cloudflare"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">version</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"~&gt; 4"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><p>As of now, all preparation is completed. Next, we will start to write down the HCL script for managing application, users, and accesses.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-whitelist-access-variables">4. Whitelist access variables<a class="hash-link" href="#4-whitelist-access-variables" title="Direct link to heading">‚Äã</a></h2><p>Fill the <code>var.whitelist-access.tf</code> file with variable definition for both whitelisted email addresses and email addresses.</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/var.whitelist-access.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">variable</span><span class="token keyword type variable" style="color:#36acaa"> "whitelist-email-addresses" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"hello@novalagung.com"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"info@novalagung.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">variable</span><span class="token keyword type variable" style="color:#36acaa"> "whitelist-ip-addresses" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">default</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"192.33.44.22/24"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"12.33.444.23/22"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Explanation:</p><ul><li>Variable <code>whitelist-email-addresses</code> contains list of email that is allowed to access the target app.</li><li>Variable <code>whitelist-ip-addresses</code> contains list of IP address that is allowed to bypass the target app.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-create-zero-trust-access-group-resource">5. Create Zero Trust access group resource<a class="hash-link" href="#5-create-zero-trust-access-group-resource" title="Direct link to heading">‚Äã</a></h2><p>The email address will not be attached directly to the zero trust policy, instead, it will be added to access group resource. Use the script below for automating the process of creating <code>my-group</code> access group resource.</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/zero-trust.access-group.my-group.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_group"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my-group"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">account_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.account-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">name</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"my-group"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">include</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">email</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.whitelist-email-addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the <code>terraform plan</code> command to validate the resources creation. If no error is visible, continue with <code>terraform apply</code> command.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-6-ff1e82284ad8b8e26601c8c38a3605be.png" width="574" height="628" class="img_ev3q"></p><p>Now open up Cloudflare Zero Trust page. Verify the newly created resource. It should be available under <code>Access</code> ‚Üí <code>Access Group</code> ‚Üí click group name (in my case it is <code>my-group</code>).</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-8-f5aaca6968f042796154ec7d2e7bd0aa.png" width="1077" height="629" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-create-zero-trust-application-resource">6. Create Zero Trust application resource<a class="hash-link" href="#6-create-zero-trust-application-resource" title="Direct link to heading">‚Äã</a></h2><p>Let's decide one domain/subdomain as the target for this practice. In my case I'm picking <code>wireguard.novalagung.com</code>, it is a WireGuard UI app I created for managing my VPN users.</p><blockquote><p>Please keep in mind, to enable Cloudflare Zero Trust on domain/subdomain, the DNS itself must be configured on Cloudflare.</p></blockquote><p>The scenario: I want to attach Zero Trust security policies to that subdomain and apply the following rules:</p><ul><li><p>1st rule: only <code>allow</code> specific email address to access the resource.</p><p>This forces the user to enter their email address when trying to access the target domain/subdomain. If the entered email address is whitelisted, Cloudflare will send 2FA verification to the email.</p><p>The access itself is only valid for 24 hours. After that, session become expired and user need to repeat the 2FA email verification process to get the access.</p><p>This type of rule access is useful for restricting access to only specific people. e.g. An internal website that the users are only your team.</p></li><li><p>2nd rule: <code>bypass</code> access from certain IP addresses.</p><p>This policy enable direct access to the target domain/subdomain without any additional verification needed. As long as the request is created on the one of the whitelisted IP addresses, then all good.</p><p>This type of rule access is useful for bypassing specific type of access to restricted site. e.g. Jenkins server that can be accessed by internal team only, but bypassing incoming webhook request from GitHub.</p></li></ul><p>Based on the above scenario, we get the following summary:</p><ul><li>Target domain: <code>wireguard.novalagung.com</code></li><li>Type: <code>self_hosted</code> (because the app is hosted on cloud)</li><li>Session duration: <code>24h</code></li><li>Policy rules:<ul><li><code>allow</code> access based on specific email addresses</li><li><code>bypass</code> access based on specific IP addresses</li></ul></li></ul><p>Now, let's prepare the HCL script. Open up the <code>zero-trust.application.wireguard.tf</code> file, fill it with the codes below:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-to-allow-access-based-on-email-addresses">‚óâ Resource to allow access based on email addresses<a class="hash-link" href="#-resource-to-allow-access-based-on-email-addresses" title="Direct link to heading">‚Äã</a></h3><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/zero-trust.application.wireguard.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_policy"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-policy-allow"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">account_id</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.account-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">name</span><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Allow access"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">decision</span><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"allow"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">session_duration</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"24h"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">include</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">group</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cloudflare_access_group.my-group.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-resource-to-bypass-access-based-on-ip-addresses">‚óâ Resource to bypass access based on IP addresses<a class="hash-link" href="#-resource-to-bypass-access-based-on-ip-addresses" title="Direct link to heading">‚Äã</a></h3><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/zero-trust.application.wireguard.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_policy"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-policy-allow"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_policy"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-policy-bypass"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">account_id</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.account-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">name</span><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Bypass access"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">decision</span><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bypass"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">session_duration</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"24h"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">include</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">ip</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.whitelist-ip-addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-access-application-resource">‚óâ Access application resource<a class="hash-link" href="#-access-application-resource" title="Direct link to heading">‚Äã</a></h3><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">File: my-project/zero-trust.application.wireguard.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_policy"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-policy-allow"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_policy"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-policy-bypass"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">resource </span><span class="token keyword type variable" style="color:#36acaa">"cloudflare_access_application"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard-access-application"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">account_id</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> var.account-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">name</span><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"WireGuard"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">domain</span><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wireguard.novalagung.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">type</span><span class="token plain">             </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"self_hosted"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">session_duration</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"24h"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">policies</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cloudflare_access_policy.wireguard-access-policy-allow.id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cloudflare_access_policy.wireguard-access-policy-bypass.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-apply-the-resource-creation">‚óâ Apply the resource creation<a class="hash-link" href="#-apply-the-resource-creation" title="Direct link to heading">‚Äã</a></h3><p>Now, run <code>terraform plan</code> to validate the resource creation plan, and then run <code>terraform apply</code>.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-9-320098dd273b935eaf201c2d8231cd1a.png" width="1191" height="497" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-test-the-zero-trust-policies">7. Test the Zero Trust policies<a class="hash-link" href="#7-test-the-zero-trust-policies" title="Direct link to heading">‚Äã</a></h2><p>Perfect! Now let's test it by opening <code>wireguard.novalagung.com</code>. If you are being directed to the Terraform Zero Trust access form, it means the Zero Trust policy has been installed successfully to the site. </p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-10-0812b8ac3aab5d2b9f982ac14d815bb4.png" width="885" height="682" class="img_ev3q"></p><p>Try to enter with one of the whitelisted emails (in my case it is <code>hello@novalagung.com</code>). After that, enter the OTP code or just click the link, either is fine.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-11-e7af8580782ead7573cd76eb932f8268.png" width="730" height="426" class="img_ev3q"></p><p>Now you finally have the access to the site. The session will be active for 24 hours.</p><p><img loading="lazy" alt="Terraform Cloudflare Zero Trust" src="/assets/images/terraform-cloudflare-zero-trust-12-915250ff04dadc655b8690a52d474fc0.png" width="945" height="418" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/terraform-aws-ec2-internet-gateway-ssh"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Automate Setup of AWS EC2 with IGW and SSH Access enabled using Terraform</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/kubernetes-minikube-deployment-service-horizontal-autoscale"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deploy App to Minikube Cluster using Deployment controller, Service, and HPA</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-terraform--opentofu-installation" class="table-of-contents__link toc-highlight">1. Terraform / OpenTofu installation</a></li><li><a href="#2-cloudflare-api-token" class="table-of-contents__link toc-highlight">2. Cloudflare API token</a></li><li><a href="#3-project-setup" class="table-of-contents__link toc-highlight">3. Project setup</a></li><li><a href="#4-whitelist-access-variables" class="table-of-contents__link toc-highlight">4. Whitelist access variables</a></li><li><a href="#5-create-zero-trust-access-group-resource" class="table-of-contents__link toc-highlight">5. Create Zero Trust access group resource</a></li><li><a href="#6-create-zero-trust-application-resource" class="table-of-contents__link toc-highlight">6. Create Zero Trust application resource</a><ul><li><a href="#-resource-to-allow-access-based-on-email-addresses" class="table-of-contents__link toc-highlight">‚óâ Resource to allow access based on email addresses</a></li><li><a href="#-resource-to-bypass-access-based-on-ip-addresses" class="table-of-contents__link toc-highlight">‚óâ Resource to bypass access based on IP addresses</a></li><li><a href="#-access-application-resource" class="table-of-contents__link toc-highlight">‚óâ Access application resource</a></li><li><a href="#-apply-the-resource-creation" class="table-of-contents__link toc-highlight">‚óâ Apply the resource creation</a></li></ul></li><li><a href="#7-test-the-zero-trust-policies" class="table-of-contents__link toc-highlight">7. Test the Zero Trust policies</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">2024 | Maintained by Noval Agung Prayogo</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b97f7968.js"></script>
<script src="/assets/js/main.621dd5f0.js"></script>

</body></html>